---
# This is an example playbook to execute Ansible tests.

- name: Verify
  hosts: all
  tasks:
    - name: gets platform current ip address
      local_action:
        module: shell
        cmd: "docker inspect --format '{''{ .NetworkSettings.IPAddress }''}' Ubuntu"
      register: platform_ip_address

    - name: checks that user can ssh into platform instance
      local_action:
        module: shell
        cmd: |
          ssh \
            -o "UserKnownHostsFile=/dev/null" \
            -o "StrictHostKeyChecking=no" \
            -i files/controller_admin \
            -p 8008 \
            controller_admin@{{ platform_ip_address.stdout }} whoami
      register: remote_whoami
      ignore_errors: yes

    - assert:
        that:
          - remote_whoami.rc == 0
          - remote_whoami.stdout == 'controller_admin'

    - name: checks that a system_agent can sudo without password
      shell:
        cmd: sudo --non-interactive cat /etc/sudoers
      become_user: controller_agent
      become: yes
      ignore_errors: yes
      register: system_agent_sudo_cat

    - assert:
        that:
          - system_agent_sudo_cat.rc == 0
